# 业务架构设计

## 架构概述

本系统采用**分层模块化架构**，以**AI调度核心**为中心，通过**MCP协议**统一管理各个平台服务，实现智能化的内容运营自动化。

### 设计原则
- **简单高效**：个人项目，避免过度设计，优先满足核心需求
- **模块化**：各模块独立，便于维护和扩展
- **可扩展**：易于接入新平台和新功能
- **数据驱动**：基于数据反馈持续优化运营策略

---

## 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户交互层                            │
│  (命令行/Web界面/API接口)                                │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  AI调度核心层                              │
│  ┌──────────────┐  ┌──────────────┐                      │
│  │  API服务层    │  │  AI决策引擎   │                      │
│  └──────────────┘  └──────────────┘                      │
│  ┌──────────────┐  ┌──────────────┐                      │
│  │  策略管理器   │  │  状态管理器   │                      │
│  └──────────────┘  └──────────────┘                      │
└────────────────────┬────────────────────────────────────┘
                     │ MCP协议
┌────────────────────▼────────────────────────────────────┐
│                  MCP服务层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ 小红书MCP服务 │  │ 图视频生成服务│  │ 数据分析服务  │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐                     │
│  │ 抖音MCP服务   │  │ 内容策略服务  │                     │
│  └──────────────┘  └──────────────┘                     │
└────────────────────┬────────────────────────────────────┘
```

---

## 核心模块设计

### 1. 用户交互层

**职责：** 提供用户与系统交互的入口

**功能模块：**
- **命令行接口（CLI）**：通过HTTP请求调用FastAPI接口，快速执行任务和查询状态
- **Web管理界面（可选）**：可视化管理和监控
- **API接口**：FastAPI提供的RESTful接口，支持程序化调用

**个人项目简化方案：**
- CLI通过调用FastAPI接口实现，统一使用Web服务
- Web界面作为可选功能，后续按需开发

---

### 2. AI调度核心层

**职责：** 系统的"大脑"，负责决策、调度和协调

#### 2.1 API服务层（API Service Layer）
- **用户请求接口**：通过FastAPI Web服务接收用户请求，主动调用AI决策层
- **平台通知接口**：通过Web服务接收各平台的新消息、评论、私信等
- **定时任务接口**：通过Web服务接收定时器触发的任务
- **数据监控接口**：通过Web服务接收数据指标变化通知

**实现方式：**
- 使用FastAPI构建Web服务接口
- 提供RESTful API接收各类事件
- 接收事件后直接调用AI决策引擎处理

#### 2.2 AI决策引擎（AI Decision Engine）
- **需求理解**：解析用户意图和事件内容
- **策略生成**：根据运营目标生成执行策略
- **任务规划**：将策略分解为可执行的任务序列
- **风险评估**：评估任务执行的风险和可行性

**实现方式：**
- 集成大语言模型（LLM）API（如OpenAI、Claude等）
- 使用提示词工程优化决策质量
- 维护上下文记忆，支持多轮对话

#### 2.3 策略管理器（Strategy Manager）
- **运营策略配置**：管理内容发布频率、互动策略等
- **热点库管理**：维护热点话题库，支持自动更新
- **内容模板管理**：管理不同类型内容的生成模板
- **策略优化**：基于数据反馈调整策略

#### 2.5 状态管理器（State Manager）
- **任务状态跟踪**：跟踪每个任务的执行状态
- **会话状态管理**：维护与用户的对话上下文
- **平台状态同步**：同步各平台的账号状态和数据

---

### 3. MCP服务层

**职责：** 通过MCP协议封装各类服务，提供标准化的接口

#### 3.1 小红书MCP服务
**功能：**
- 内容发布：发布图文、视频内容
- 互动管理：回复评论、处理私信、点赞
- 内容搜索：搜索热点内容、竞品分析
- 账号管理：账号信息查询、数据统计

**技术实现：**
- 基于浏览器自动化（Playwright/Selenium）

#### 3.2 图视频生成服务（ComfyUI MCP）
**功能：**
- 文生图：根据文本描述生成图片
- 图生图：基于现有图片生成新图片
- 视频生成：生成短视频内容
- 素材管理：管理生成的素材库

**技术实现：**
- 基于ComfyUI封装为MCP服务
- 支持自定义工作流和模型切换

#### 3.3 数据分析服务（规划中）
**功能：**
- 内容表现分析：阅读量、点赞、评论等数据统计
- 趋势分析：识别内容趋势和热点
- 竞品分析：分析竞品账号的表现
- 数据可视化：生成数据报表

#### 3.4 内容策略服务（规划中）
**功能：**
- 内容生成：基于策略生成内容文案
- 话题推荐：推荐适合的话题和标签
- 发布时间优化：推荐最佳发布时间
- A/B测试：支持内容策略的A/B测试

---

### 4. 平台适配层

**职责：** 封装各平台的具体实现细节

**实现方式：**
- **浏览器自动化**：使用Playwright/Selenium控制浏览器
- **API调用**：调用平台官方API（如有）
- **数据爬取**：爬取平台公开数据

**个人项目注意：**
- 注意反爬虫机制，合理控制请求频率
- 使用代理和账号轮换降低风险

---

### 5. 数据存储层

**职责：** 持久化存储各类数据

#### 5.1 内容数据库
- 生成的内容文案和素材
- 发布历史记录
- 内容模板和素材库

#### 5.2 运营数据
- 平台数据统计（阅读量、点赞、评论等）
- 账号数据（粉丝数、互动率等）
- 热点话题库
- 竞品分析数据

#### 5.3 配置数据
- 账号配置信息
- 运营策略配置
- 系统配置参数

**技术选型（个人项目）：**
- **SQLite**：轻量级，适合个人项目
- **JSON文件**：简单配置数据
- **可选：PostgreSQL/MySQL**：如数据量大或需要复杂查询

---

## 业务流程设计

### 流程1：用户请求内容发布

```
用户输入请求
    ↓
API服务层接收
    ↓
AI决策引擎理解需求
    ↓
策略管理器生成内容策略
    ↓
调用图视频生成服务生成素材
    ↓
调用小红书MCP服务发布内容
    ↓
状态管理器记录执行结果
    ↓
返回结果给用户
```

### 流程2：自动回复评论

```
平台通知事件（新评论）
    ↓
API服务层接收
    ↓
AI决策引擎分析评论内容
    ↓
生成回复内容
    ↓
调用小红书MCP服务回复评论
    ↓
状态管理器更新互动记录
```

### 流程3：定时内容发布

```
定时任务事件触发
    ↓
AI决策引擎生成内容计划
    ↓
策略管理器选择话题和模板
    ↓
调用图视频生成服务生成素材
    ↓
调用小红书MCP服务发布
    ↓
数据分析服务收集数据
    ↓
策略管理器优化后续策略
```

### 流程4：热点内容追踪与发布

```
定时任务触发热点监控
    ↓
调用小红书MCP服务搜索热点话题
    ↓
AI决策引擎分析热点相关性
    ↓
策略管理器匹配内容策略
    ↓
AI决策引擎生成热点内容方案
    ↓
调用图视频生成服务生成素材
    ↓
调用小红书MCP服务发布热点内容
    ↓
状态管理器记录热点追踪数据
```

### 流程5：数据异常处理

```
数据分析服务检测到数据异常
    ↓
API服务层接收异常事件
    ↓
AI决策引擎分析异常原因
    ↓
风险评估异常影响
    ↓
生成处理策略（暂停/调整/继续）
    ↓
直接执行处理动作（暂停发布/调整策略等）
    ↓
状态管理器记录异常和处理结果
    ↓
通知用户（如需要）
```

### 流程6：竞品分析与策略调整

```
定时任务触发竞品分析
    ↓
调用小红书MCP服务搜索竞品内容
    ↓
数据分析服务分析竞品数据
    ↓
AI决策引擎识别竞品策略
    ↓
策略管理器对比自身策略
    ↓
AI决策引擎生成优化建议
    ↓
策略管理器更新运营策略
    ↓
状态管理器记录分析结果
```

### 流程7：私信自动处理

```
平台通知事件（新私信）
    ↓
API服务层接收
    ↓
AI决策引擎分析私信内容
    ↓
判断是否需要人工介入
    ↓
生成自动回复内容（如可自动处理）
    ↓
调用小红书MCP服务回复私信
    ↓
状态管理器记录私信处理记录
    ↓
标记需人工处理的私信（如需要）
```

### 流程8：内容表现分析与优化

```
定时任务触发数据分析
    ↓
调用小红书MCP服务获取内容数据
    ↓
数据分析服务分析内容表现
    ↓
AI决策引擎识别高/低表现内容特征
    ↓
策略管理器提取成功模式
    ↓
更新内容模板和策略库
    ↓
生成内容优化建议
    ↓
状态管理器记录分析结果
```

---

## 业务流程实施计划

### 实施原则

1. **自底向上**：先搭建基础设施，再实现业务流程
2. **最小可用**：每个阶段实现最小可用版本（MVP）
3. **迭代优化**：每个阶段完成后进行测试和优化
4. **依赖优先**：优先实现被其他流程依赖的模块

---