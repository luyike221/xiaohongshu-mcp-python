"""é”™è¯¯è§£æå·¥å…·"""
def parse_genai_error(error: Exception) -> str:
    """
    è§£æ Google GenAI API é”™è¯¯ï¼Œè¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯

    è¯†åˆ«çš„é”™è¯¯ç±»å‹ï¼š
    - 401 UNAUTHENTICATED: API Key æ— æ•ˆæˆ–è®¤è¯å¤±è´¥
    - 403 PERMISSION_DENIED: æƒé™ä¸è¶³
    - 404 NOT_FOUND: æ¨¡å‹ä¸å­˜åœ¨
    - 429 RESOURCE_EXHAUSTED: é…é¢ç”¨å°½æˆ–é€Ÿç‡é™åˆ¶
    - 400 INVALID_ARGUMENT: å‚æ•°é”™è¯¯
    - 500 INTERNAL: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
    - 503 UNAVAILABLE: æœåŠ¡ä¸å¯ç”¨
    - å®‰å…¨è¿‡æ»¤ç›¸å…³é”™è¯¯
    - ç½‘ç»œè¿æ¥é”™è¯¯
    """
    error_str = str(error).lower()
    error_original = str(error)

    # 401 è®¤è¯é”™è¯¯
    if "401" in error_str or "unauthenticated" in error_str:
        if "api key" in error_str and "not supported" in error_str:
            return (
                "âŒ API Key è®¤è¯å¤±è´¥ï¼šVertex AI ä¸æ”¯æŒ API Key\n\n"
                "ã€é”™è¯¯åŸå› ã€‘\n"
                "æ‚¨å¯èƒ½è¯¯ç”¨äº† Vertex AI æ¨¡å¼ï¼Œè¯¥æ¨¡å¼éœ€è¦ OAuth2 è®¤è¯è€Œé API Keyã€‚\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. å¦‚æœæ‚¨ä½¿ç”¨ Google AI Studio çš„ API Keyï¼š\n"
                "   - ç¡®ä¿åœ¨è®¾ç½®ä¸­æ²¡æœ‰é…ç½® base_urlï¼ˆç•™ç©ºå³å¯ï¼‰\n"
                "   - API Key è·å–åœ°å€: https://aistudio.google.com/app/apikey\n\n"
                "2. å¦‚æœæ‚¨ä½¿ç”¨ Google Cloud çš„ API Keyï¼š\n"
                "   - ç¡®ä¿ API Key å·²å¯ç”¨ Generative Language API\n"
                "   - åœ¨ Google Cloud Console æ£€æŸ¥ API æƒé™\n\n"
                "3. å¦‚æœæ‚¨ç¡®å®éœ€è¦ä½¿ç”¨ Vertex AIï¼š\n"
                "   - Vertex AI éœ€è¦ Service Account è®¤è¯ï¼Œä¸æ”¯æŒ API Key\n"
                "   - è¯·å‚è€ƒæ–‡æ¡£é…ç½® Application Default Credentials"
            )
        else:
            return (
                "âŒ API Key è®¤è¯å¤±è´¥\n\n"
                "ã€å¯èƒ½åŸå› ã€‘\n"
                "1. API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ\n"
                "2. API Key æ ¼å¼é”™è¯¯ï¼ˆå¤åˆ¶æ—¶å¯èƒ½åŒ…å«ç©ºæ ¼ï¼‰\n"
                "3. API Key è¢«ç¦ç”¨æˆ–åˆ é™¤\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®å¤åˆ¶ï¼ˆæ— å¤šä½™ç©ºæ ¼ï¼‰\n"
                "2. å‰å¾€ Google AI Studio é‡æ–°ç”Ÿæˆ API Key:\n"
                "   https://aistudio.google.com/app/apikey\n"
                "3. ç¡®ä¿ API Key å¯¹åº”çš„é¡¹ç›®å·²å¯ç”¨ç›¸å…³ API"
            )

    # 403 æƒé™é”™è¯¯
    if "403" in error_str or "permission_denied" in error_str or "forbidden" in error_str:
        if "billing" in error_str or "quota" in error_str:
            return (
                "âŒ æƒé™è¢«æ‹’ç»ï¼šè®¡è´¹æœªå¯ç”¨æˆ–é…é¢ä¸è¶³\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. æ£€æŸ¥ Google Cloud é¡¹ç›®æ˜¯å¦å·²å¯ç”¨è®¡è´¹\n"
                "2. æ£€æŸ¥ API é…é¢æ˜¯å¦å·²ç”¨å°½\n"
                "3. å¦‚æœæ˜¯å…è´¹è¯•ç”¨è´¦æˆ·ï¼Œå¯èƒ½æœ‰ä½¿ç”¨é™åˆ¶"
            )
        elif "region" in error_str or "location" in error_str:
            return (
                "âŒ æƒé™è¢«æ‹’ç»ï¼šåŒºåŸŸé™åˆ¶\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. æŸäº› API å¯èƒ½åœ¨æ‚¨çš„åœ°åŒºä¸å¯ç”¨\n"
                "2. å°è¯•ä½¿ç”¨ä»£ç†æˆ–é…ç½® base_url æŒ‡å‘å¯ç”¨åŒºåŸŸ"
            )
        else:
            return (
                "âŒ æƒé™è¢«æ‹’ç»\n\n"
                "ã€å¯èƒ½åŸå› ã€‘\n"
                "1. API Key æ²¡æœ‰è®¿é—®è¯¥æ¨¡å‹çš„æƒé™\n"
                "2. æ¨¡å‹å¯èƒ½éœ€è¦ç‰¹æ®Šæƒé™æˆ–ç™½åå•\n"
                "3. é¡¹ç›®é…é¢æˆ–é™åˆ¶\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. æ£€æŸ¥ Google Cloud Console ä¸­çš„ API æƒé™\n"
                "2. ç¡®è®¤æ¨¡å‹æ˜¯å¦å¯¹æ‚¨çš„è´¦æˆ·å¼€æ”¾\n"
                "3. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹ï¼ˆå¦‚ gemini-2.0-flash-expï¼‰"
            )

    # 404 èµ„æºä¸å­˜åœ¨
    if "404" in error_str or "not_found" in error_str or "not found" in error_str:
        if "model" in error_str:
            return (
                "âŒ æ¨¡å‹ä¸å­˜åœ¨\n\n"
                "ã€å¯èƒ½åŸå› ã€‘\n"
                "1. æ¨¡å‹åç§°æ‹¼å†™é”™è¯¯\n"
                "2. è¯¥æ¨¡å‹å·²ä¸‹çº¿æˆ–æ›´å\n"
                "3. è¯¥æ¨¡å‹å°šæœªåœ¨æ‚¨çš„åŒºåŸŸå¼€æ”¾\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦æ­£ç¡®\n"
                "2. æ¨èä½¿ç”¨çš„æ¨¡å‹ï¼š\n"
                "   - gemini-2.0-flash-exp\n"
                "   - gemini-1.5-pro\n"
                "3. æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£è·å–æœ€æ–°å¯ç”¨æ¨¡å‹åˆ—è¡¨"
            )
        else:
            return (
                "âŒ è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨\n\n"
                f"ã€åŸå§‹é”™è¯¯ã€‘{error_original[:200]}\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘æ£€æŸ¥ API ç«¯ç‚¹å’Œå‚æ•°é…ç½®"
            )

    # 429 é€Ÿç‡é™åˆ¶/é…é¢ç”¨å°½
    if "429" in error_str or "resource_exhausted" in error_str or "quota" in error_str:
        if "per minute" in error_str or "rpm" in error_str:
            return (
                "â³ è¯·æ±‚é¢‘ç‡è¶…é™ï¼ˆRPM é™åˆ¶ï¼‰\n\n"
                "ã€è¯´æ˜ã€‘\n"
                "æ‚¨çš„è¯·æ±‚é¢‘ç‡è¶…è¿‡äº†æ¯åˆ†é’Ÿé™åˆ¶ã€‚\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. ç¨ç­‰ç‰‡åˆ»åé‡è¯•\n"
                "2. å‡å°‘åŒæ—¶ç”Ÿæˆçš„è¯·æ±‚æ•°é‡"
            )
        elif "per day" in error_str or "daily" in error_str:
            return (
                "â³ æ¯æ—¥é…é¢å·²ç”¨å°½\n\n"
                "ã€è¯´æ˜ã€‘\n"
                "æ‚¨ä»Šå¤©çš„ API è°ƒç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™ã€‚\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. ç­‰å¾…æ˜å¤©é…é¢é‡ç½®ï¼ˆé€šå¸¸åœ¨ UTC 0:00ï¼‰\n"
                "2. å‡çº§åˆ°ä»˜è´¹è®¡åˆ’è·å–æ›´å¤šé…é¢\n"
                "3. ä½¿ç”¨å…¶ä»– API Key"
            )
        else:
            return (
                "â³ API é…é¢æˆ–é€Ÿç‡é™åˆ¶\n\n"
                "ã€å¯èƒ½åŸå› ã€‘\n"
                "1. è¯·æ±‚é¢‘ç‡è¿‡é«˜\n"
                "2. å…è´¹é…é¢å·²ç”¨å°½\n"
                "3. è´¦æˆ·é…é¢è¾¾åˆ°ä¸Šé™\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. ç¨åå†è¯•ï¼ˆé€šå¸¸ç­‰å¾… 1-2 åˆ†é’Ÿï¼‰\n"
                "2. æ£€æŸ¥ Google Cloud Console ä¸­çš„é…é¢ä½¿ç”¨æƒ…å†µ\n"
                "3. è€ƒè™‘å‡çº§è®¡åˆ’æˆ–ç”³è¯·æ›´å¤šé…é¢"
            )

    # 400 å‚æ•°é”™è¯¯
    if "400" in error_str or "invalid_argument" in error_str or "invalid" in error_str:
        if "prompt" in error_str or "content" in error_str:
            return (
                "âŒ æç¤ºè¯å‚æ•°é”™è¯¯\n\n"
                "ã€å¯èƒ½åŸå› ã€‘\n"
                "1. æç¤ºè¯è¿‡é•¿\n"
                "2. æç¤ºè¯åŒ…å«ä¸æ”¯æŒçš„å­—ç¬¦\n"
                "3. æç¤ºè¯è§¦å‘äº†å†…å®¹è¿‡æ»¤\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
                "1. å°è¯•ç¼©çŸ­æç¤ºè¯\n"
                "2. ç§»é™¤ç‰¹æ®Šå­—ç¬¦æˆ–æ•æ„Ÿå†…å®¹\n"
                "3. ä½¿ç”¨æ›´ä¸­æ€§çš„æè¿°"
            )
        else:
            return (
                f"âŒ è¯·æ±‚å‚æ•°é”™è¯¯\n\n"
                f"ã€åŸå§‹é”™è¯¯ã€‘{error_original[:300]}\n\n"
                "ã€è§£å†³æ–¹æ¡ˆã€‘æ£€æŸ¥è¯·æ±‚å‚æ•°æ˜¯å¦æ­£ç¡®"
            )

    # å®‰å…¨è¿‡æ»¤
    if "safety" in error_str or "blocked" in error_str or "filter" in error_str:
        return (
            "ğŸ›¡ï¸ å†…å®¹è¢«å®‰å…¨è¿‡æ»¤å™¨æ‹¦æˆª\n\n"
            "ã€è¯´æ˜ã€‘\n"
            "æ‚¨çš„æç¤ºè¯æˆ–ç”Ÿæˆå†…å®¹è§¦å‘äº† Google çš„å®‰å…¨è¿‡æ»¤æœºåˆ¶ã€‚\n\n"
            "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
            "1. ä¿®æ”¹æç¤ºè¯ï¼Œä½¿ç”¨æ›´ä¸­æ€§çš„æè¿°\n"
            "2. é¿å…æ¶‰åŠæ•æ„Ÿè¯é¢˜çš„å†…å®¹\n"
            "3. å°è¯•æ¢ä¸€ç§è¡¨è¾¾æ–¹å¼æè¿°ç›¸åŒå†…å®¹"
        )

    # 500 æœåŠ¡å™¨é”™è¯¯
    if "500" in error_str or "internal" in error_str:
        return (
            "âš ï¸ Google API æœåŠ¡å™¨å†…éƒ¨é”™è¯¯\n\n"
            "ã€è¯´æ˜ã€‘\n"
            "è¿™æ˜¯ Google æœåŠ¡ç«¯çš„ä¸´æ—¶æ•…éšœï¼Œä¸æ‚¨çš„é…ç½®æ— å…³ã€‚\n\n"
            "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
            "1. ç¨ç­‰å‡ åˆ†é’Ÿåé‡è¯•\n"
            "2. å¦‚æœæŒç»­å‡ºç°ï¼Œæ£€æŸ¥ Google Cloud Status é¡µé¢"
        )

    # 503 æœåŠ¡ä¸å¯ç”¨
    if "503" in error_str or "unavailable" in error_str:
        return (
            "âš ï¸ æœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n\n"
            "ã€è¯´æ˜ã€‘\n"
            "Google API æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå¯èƒ½æ˜¯ç»´æŠ¤æˆ–è¿‡è½½ã€‚\n\n"
            "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
            "1. ç¨ç­‰å‡ åˆ†é’Ÿåé‡è¯•\n"
            "2. æ£€æŸ¥ Google Cloud Status é¡µé¢äº†è§£æœåŠ¡çŠ¶æ€"
        )

    # ç½‘ç»œè¿æ¥é”™è¯¯
    if "connection" in error_str or "timeout" in error_str or "network" in error_str:
        return (
            "ğŸŒ ç½‘ç»œè¿æ¥é”™è¯¯\n\n"
            "ã€å¯èƒ½åŸå› ã€‘\n"
            "1. ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n"
            "2. è¯·æ±‚è¶…æ—¶\n"
            "3. é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®é—®é¢˜\n\n"
            "ã€è§£å†³æ–¹æ¡ˆã€‘\n"
            "1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n"
            "2. æ£€æŸ¥é˜²ç«å¢™å’Œä»£ç†è®¾ç½®\n"
            "3. å¦‚æœä½¿ç”¨ base_urlï¼Œç¡®è®¤åœ°å€å¯è®¿é—®"
        )

    # é»˜è®¤é”™è¯¯ä¿¡æ¯
    return (
        f"âŒ API è¯·æ±‚å¤±è´¥\n\n"
        f"ã€åŸå§‹é”™è¯¯ã€‘\n{error_original[:500]}\n\n"
        "ã€é€šç”¨è§£å†³æ–¹æ¡ˆã€‘\n"
        "1. æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®\n"
        "2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n"
        "3. æŸ¥çœ‹ Google Cloud Console ä¸­çš„é”™è¯¯æ—¥å¿—"
    )

